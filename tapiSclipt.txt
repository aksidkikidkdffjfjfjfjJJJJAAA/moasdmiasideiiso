-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯æ©Ÿèƒ½
local PASSWORD = "tapi"  -- ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„

function passwordCheck()
    local input = gg.prompt({"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ä½¿ç”¨æ¨©é™)ã¯Discordã§è³¼å…¥å‡ºæ¥ã¾ã™"}, nil, {"text"})
    if input == nil or input[1] ~= PASSWORD then
        gg.alert("âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™!!!\n\nã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’çµ‚äº†ã—ã¾ã™ã€‚")
        os.exit()
    else
        gg.alert("âœ… èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ\n\nğŸ“±ç¾åœ¨ã®ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€˜4.141.0ã€™\n\nğŸˆ²2æ¬¡é…å¸ƒãŒç™ºè¦šã—ãŸå ´åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™\n\nğŸ‘¤è³ªå•ã¯Discordã¾ã§")
    end
end

passwordCheck()  -- èµ·å‹•æ™‚ã«å®Ÿè¡Œ
local config = {}
local configKeys = {}
local savedConfigs = {} -- ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã”ã¨ã®çŠ¶æ…‹ã‚’ä¿å­˜

local subConfigs = {
    Main = {
        {
            Func = function(value) Baisokuu(value) end,
            Type = "InputValue",
            Name = "å€é€Ÿ[1;5]",
            value = 1,
            State = true,
        },
        {
            Func = function(value) Tienn(value) end,
            Type = "InputValue",
            Name = "é…å»¶[1;4]",
            value = 1,
            State = true,
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "1.5å€é€Ÿ",
            lib = "libSGF.so",
            Offset = 0x2922CE4,
            ONHex = "00 28 28 1E",
            OFFHex = "EB FE FF 54",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãƒ¯ãƒ³ãƒ‘ãƒ³",
            lib = "libSGF.so",
            Offset = 0x325F754,
            ONHex = "80 00 00 54",
            OFFHex = "81 00 00 54",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "9ä¸‡ãƒ¯ãƒ³ãƒ‘ãƒ³",
            lib = "libSGF.so",
            Offset = 0x325F740,
            ONHex = "F3 07 11 32",
            OFFHex = "F3 03 01 2A",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ç„¡æ•µ",
            lib = "libSGF.so",
            Offset = 0x34589C4,
            ONHex = "C0 03 5F D6",
            OFFHex = "FF C3 02 D1",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "è»½é‡åŒ–",
            lib = "libSGF.so",
            Offset = 0x28FECD4,
            ONHex = "81 62 80 52",
            OFFHex = "81 00 80 52",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãƒªã‚¶ãƒ«ãƒˆã‚¹ã‚­ãƒƒãƒ—",
            lib = "libSGF.so",
            Offset = 0x344BAA4,
            ONHex = "1F 04 00 71",
            OFFHex = "1F 08 00 71",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ç„¡åŠ¹åŒ–ä¸€æ‹¬",
            lib = "libSGF.so",
            Offset = {0x3A7C1EC,
                      0x496FEB8,--ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç„¡åŠ¹
                      0x44E5744,--ãƒ•ãƒ¬ã‚¢ã‚¤ã‚³ãƒ³
                      0x3A7C1EC,
                      0x3B121F0,
                      0x3B8CBA4,
                      0x3F5AA5C,
                      0x3F631D0}, -- è¤‡æ•°ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            ONHex = {"C0 03 5F D6",
                      "C0 03 5F D6",--ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç„¡åŠ¹
                      "C0 03 5F D6",
                      "C0 03 5F D6",
                      "C0 03 5F D6",
                      "29 02 00 35",
                      "68 07 00 35",
                      "21 03 00 35"},
            OFFHex = {"FF 83 03 D1",
                       "FF 83 01 D1",--ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç„¡åŠ¹
                       "FF 03 03 D1",
                       "FF 83 06 D1",
                       "FF 43 04 D1",
                       "28 02 00 34",
                       "68 07 00 34",
                       "21 03 00 34",
                       },
            value = false,
            State = true,
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ã‚¹ã‚³ã‚¢ã‚«ãƒ³ã‚¹ãƒˆ",
            lib = "libSGF.so",
            Offset = 0x34588FC,
            ONHex = "01 AC 15 8B",
            OFFHex = "01 00 15 8B",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = function() MainMenu() end,
            Type = "Toggle",
            Name = "æˆ»ã‚‹",
            value = false,
            State = true,
        }
    },
    Puzzle = {
        {
            Func = nil,
            Type = "Toggle",
            Name = "å³å‹åˆ©",
            lib = "libSGF.so",
            Offset = 0x345AF64,
            ONHex = "41 01 00 54",
            OFFHex = "40 01 00 54",
            value = false,
            State = true,
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "å³ãƒ•ã‚£ãƒ¼ãƒãƒ¼",
            lib = "libSGF.so",
            Offset = 0x34AF1D4,
            ONHex = "3F 05 00 71",
            OFFHex = "3F 01 00 71",
            value = false,
            State = true,
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ç„¡é™ãƒ•ã‚£ãƒ¼ãƒãƒ¼",
            lib = "libSGF.so",
            Offset = 0x3EEC794,
            ONHex = "3F 05 00 71",
            OFFHex = "3F 01 00 71",
            value = false,
            State = true,
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "å³æŠ€",
            lib = "libSGF.so",
            Offset = 0x2E8CA9C,
            ONHex = "1F 20 03 D5",
            OFFHex = "01 01 27 1E",
            value = false,
            State = true,
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãƒœãƒŠç‰ç”Ÿæˆ",
            lib = "libSGF.so",
            Offset = 0x363B1F8,
            ONHex = "BF 01 0D 6B",
            OFFHex = "BF 01 08 6B",
            value = false,
            State = true,
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "å…¨ã·ã«ç¹‹ãŒã‚‹",
            lib = "libSGF.so",
            Offset = 0x323407C,
            ONHex = "08 1C A0 4E",
            OFFHex = "80 FC 07 36",
            value = false,
            State = true,
        },
        {
            Func = function() MainMenu() end,
            Type = "Toggle",
            Name = "æˆ»ã‚‹",
            value = false,
            State = true,
        }
    },
    Disable = {
        {
            Func = nil,
            Type = "Toggle",
            Name = "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x496FEB8,
            ONHex = "C0 03 5F D6",
            OFFHex = "FF 83 01 D1",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "è™«çœ¼é¡ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x3B8CC18,
            ONHex = "C0 03 5F D6",
            OFFHex = "FF 83 06 D1",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãƒ•ãƒ¬ã‚¢ã‚¤ã‚³ãƒ³ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x3B12264,
            ONHex = "C0 03 5F D6",
            OFFHex = "FF 03 03 D1",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "å°å°ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x3BA96D4,
            ONHex = "C0 03 5F D6",
            OFFHex = "FF 43 04 D1",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "éµæ¼”å‡ºç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x3F644C4,
            ONHex = "21 03 00 35",
            OFFHex = "21 03 00 34",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãŠçŸ¥ã‚‰ã›ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x3F5AAB8,
            ONHex = "28 02 00 35",
            OFFHex = "28 02 00 34",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ã‚¹ã‚³ã‚¢ã‚¿ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x48f930c,
            ONHex = "28 03 00 35",
            OFFHex = "28 03 00 34",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ã‚²ãƒ¼ãƒˆæ¼”å‡ºç„¡åŠ¹",
            value = false,
            State = true,
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆç„¡åŠ¹",
            value = false,
            State = true,
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãƒ­ã‚°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒ—ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x3F6322C,
            ONHex = "68 07 00 35",
            OFFHex = "68 07 00 34",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœã‚¿ãƒ³ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x44E0BD8,
            ONHex = "C0 03 5F D6",
            OFFHex = "FD 7B BA A9",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = function() MainMenu() end,
            Type = "Toggle",
            Name = "æˆ»ã‚‹",
            value = false,
            State = true,
        }
    },
    Other = {
        {
            Func = nil,
            Type = "Toggle",
            Name = "104ä¸‡ãƒ€ãƒ¡",
            lib = "libSGF.so",
            Offset = 0x325F784,
            ONHex = "13 02 A0 52",
            OFFHex = "F3 03 01 2A",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ã‚¤ãƒ™ã‚¹ãƒ†ã‚†ã†ã³ã‚“è§£æ”¾",
            lib = "libSGF.so",
            Offset = {0x3CDC228,
                      0x44e01cc}, 
            ONHex = {"E1 03 1F 2A",
                      "C0 03 5F D6"},
            OFFHex = {"21 00 80 52",
                       "FF 03 01 D1"},
            value = false,
            State = true,
            ToggleStatus = true
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x5151274,
            ONHex = "00 00 00 00",
            OFFHex = "01 01 01 01",
            value = false,
            State = true,
            ToggleStatus = true -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ã‚¹ã‚³ã‚¢ã‚¿æ™‚é–“åœæ­¢",
            lib = "libSGF.so",
            Offset = 0x395BE40,
            ONHex = "20 00 80 52",
            OFFHex = "E0 03 13 2A",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ[å…¨æ©Ÿç¨®å¯¾å¿œ]",
            lib = "libSGF.so",
            Offset = 0x37D6A18,
            ONHex = "D4 00 00 B4",
            OFFHex = "D4 00 00 B5",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = function() SaveMenus() end,
            Type = "Toggle",
            Name = "æ©Ÿèƒ½ä¿å­˜",
            value = false,
            State = true,
        },
        {
            Func = function() PopMenus() end,
            Type = "Toggle",
            Name = "æ©Ÿèƒ½å¾©å…ƒ",
            value = false,
            State = true,
        },
        {
            Func = function() MainMenu() end,
            Type = "Toggle",
            Name = "æˆ»ã‚‹",
            value = false,
            State = true,
        }
    },
    Drop = {
        {
            Func = nil,
            Type = "Toggle",
            Name = "å¦–æ€ªç¢ºå®šãƒ‰ãƒ­ãƒƒãƒ—",
            lib = "libSGF.so",
            Offset = 0x3956FB8,
            ONHex = "20 00 80 52",
            OFFHex = "E0 03 1F 2A",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ç¢ºå®šãƒ‰ãƒ­ãƒƒãƒ—ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x3956F64,
            ONHex = "33 00 80 52",
            OFFHex = "F3 03 1F 2A",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "ã‚¢ã‚¤ãƒ†ãƒ ãƒ‰ãƒ­ãƒƒãƒ—ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x3956B9C,
            ONHex = "C0 03 5F D6",
            OFFHex = "FD 7B BC A9",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = nil,
            Type = "Toggle",
            Name = "éµãƒ‰ãƒ­ãƒƒãƒ—ç„¡åŠ¹",
            lib = "libSGF.so",
            Offset = 0x3F54924,
            ONHex = "E2 03 1F 2A",
            OFFHex = "E2 03 00 2A",
            value = false,
            State = true,
            ToggleStatus = false -- å€‹åˆ¥ã®ToggleStatus
        },
        {
            Func = function() MainMenu() end,
            Type = "Toggle",
            Name = "æˆ»ã‚‹",
            value = false,
            State = true,
        }
    }
}

-- å€é€Ÿå‡¦ç†é–¢æ•°
function Baisokuu(value)
    local hexValues = {
        [1] = "EB FE FF 54",
        [2] = "00 10 28 1E",
        [3] = "00 D0 28 1E",
        [4] = "00 50 28 1E",
        [5] = "00 10 2A 1E"
    }

    if hexValues[value] then
        setHexMemory("libSGF.so", 0x2922CE4, hexValues[value])
        gg.toast("å€é€Ÿ: " .. (value == 1 and "OFF" or value .. "å€é€Ÿã‚’è¨­å®šã—ã¾ã—ãŸã€‚"))
    else
        gg.alert("ã‚¨ãƒ©ãƒ¼: ç„¡åŠ¹ãªå€é€Ÿå€¤ã§ã™ï¼ (å…¥åŠ›å€¤: " .. tostring(value) .. ")")
    end
end

-- é…å»¶å‡¦ç†é–¢æ•°
function Tienn(value)
    local hexValues = {
        [1] = "00 18 28 1E",
        [2] = "00 50 2A 1E",
        [3] = "00 D0 28 1E",
        [4] = "00 10 28 1E"
    }

    if hexValues[value] then
        setHexMemory("libSGF.so", 0x3081850, hexValues[value])
        gg.toast("é…å»¶: " .. (value == 1 and "OFF" or value .. "ã‚’è¨­å®šã—ã¾ã—ãŸã€‚"))
    else
        gg.alert("ã‚¨ãƒ©ãƒ¼: ç„¡åŠ¹ãªé…å»¶å€¤ã§ã™ï¼ (å…¥åŠ›å€¤: " .. tostring(value) .. ")")
    end
end

function isim(lib)
    -- ä¿å­˜ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªæƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
    local savedLib = loadSavedLibrary()
    if savedLib then
        lib = savedLib -- ä¿å­˜ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
    end

    local ranges = gg.getRangesList(lib or 'libSGF.so') -- æŒ‡å®šã•ã‚ŒãŸ lib ãŒå­˜åœ¨ã—ãªã„å ´åˆ 'libSGF.so' ã‚’ä½¿ç”¨
    if #ranges == 0 then
        gg.alert("Error: æŒ‡å®šã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª (" .. lib .. ") ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä»£æ›¿ãƒ©ã‚¤ãƒ–ãƒ©ãƒª arm64_v8a.apk ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚")
        
        -- arm64_v8a.apk ã®æœ€åˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
        lib = 'arm64_v8a.apk'  -- arm64_v8a.apk å†…ã®å®Ÿéš›ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®š
        ranges = gg.getRangesList(lib)
        
        -- arm64_v8a.apk ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€æœ€åˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é¸æŠ
        if #ranges > 0 then
            -- arm64_v8a.apk å†…ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æœ€åˆã®ç¯„å›²ã‚’ä½¿ç”¨
            lib = ranges[1].name  -- æœ€åˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåã‚’å–å¾—
            saveLibrary(lib)  -- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä¿å­˜
        else
            gg.alert("Error: arm64_v8a.apk ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
            return nil, nil
        end
    end

    -- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
    if #ranges == 0 then
        gg.alert("Error: ä»£æ›¿ãƒ©ã‚¤ãƒ–ãƒ©ãƒª " .. lib .. " ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        return nil, nil
    end

    -- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¯„å›²ã‚’æ¤œç´¢
    for _, range in ipairs(ranges) do
        if range.state == "Xa" then
            startAddress = range.start
            endAddress = range['end']
            return startAddress, endAddress
        end
    end

    gg.alert("Error: " .. lib .. " ã®ç¯„å›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    return nil, nil
end

-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæƒ…å ±ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
function saveLibrary(lib)
    local filePath = "/storage/emulated/0/PuniChangeLibrary.lua"
    local file = io.open(filePath, "w")
    if file then
        file:write("return '" .. lib .. "'") -- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåã‚’ä¿å­˜
        file:close()
        gg.toast("ãƒ©ã‚¤ãƒ–ãƒ©ãƒª " .. lib .. " ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚")
    else
        gg.alert("ã‚¨ãƒ©ãƒ¼: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
    end
end

function loadSavedLibrary()
    local filePath = "/storage/emulated/0/PuniChangeLibrary.lua"
    local file = io.open(filePath, "r")
    
    -- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿èª­ã¿è¾¼ã‚€
    if file then
        local savedData = file:read("*all")
        file:close()
        local success, lib = pcall(load(savedData))
        
        -- èª­ã¿è¾¼ã¿æˆåŠŸã—ãŸå ´åˆã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæƒ…å ±ã‚’è¿”ã™
        if success then
            return lib
        else
            gg.alert("ã‚¨ãƒ©ãƒ¼: ä¿å­˜ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
            return nil
        end
    else
        -- ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç„¡è¦–ã™ã‚‹
        return nil
    end
end

-- ãƒˆã‚°ãƒ«å‡¦ç†ã®è‡ªå‹•åŒ–ï¼ˆè¤‡æ•°ã‚ªãƒ•ã‚»ãƒƒãƒˆå¯¾å¿œï¼‰
local function autoToggle(entry)
    if not entry.lib or not entry.Offset or not entry.ONHex or not entry.OFFHex then return end
    if type(entry.Offset) ~= "table" then
        entry.Offset = {entry.Offset} -- å˜ä¸€å€¤ã‚’é…åˆ—ã«å¤‰æ›
    end
    if type(entry.ONHex) ~= "table" then
        entry.ONHex = {entry.ONHex}
    end
    if type(entry.OFFHex) ~= "table" then
        entry.OFFHex = {entry.OFFHex}
    end

    entry.value = not entry.value
    for i, offset in ipairs(entry.Offset) do
        local hex = entry.value and (entry.ONHex[i] or entry.ONHex[1]) or (entry.OFFHex[i] or entry.OFFHex[1])
        local success = setHexMemory(entry.lib, offset, hex)
        if not success then
        end
    end

    gg.toast(entry.Name .. (entry.value and " âŸ¬ONâŸ­" or " âŸ¬OFFâŸ­"))
end

-- ãƒ¡ãƒ¢ãƒªã‚’è¨­å®šã™ã‚‹é–¢æ•°ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆã”ã¨ã«Hexå€¤ã‚’è¨­å®šï¼‰
function setHexMemory(libName, offset, hex)
    local startAddress = isim(libName)
    if not startAddress then return false end
    local values = {}
    local index = 0
    for byte in string.gmatch(hex, "%S%S") do
        table.insert(values, {address = startAddress + offset + index, flags = gg.TYPE_BYTE, value = byte .. "r"})
        index = index + 1
    end
    local success = gg.setValues(values)
    return type(success) ~= "string" -- æˆåŠŸã®å ´åˆã¯ true ã‚’è¿”ã™
end

-- è¨­å®šå¤‰æ›´ãƒ¡ãƒ‹ãƒ¥ãƒ¼
function editHexValues(entry)
    if type(entry.Offset) ~= "table" then
        entry.Offset = {entry.Offset}
    end
    if type(entry.ONHex) ~= "table" then
        entry.ONHex = {entry.ONHex}
    end
    if type(entry.OFFHex) ~= "table" then
        entry.OFFHex = {entry.OFFHex}
    end

    local prompts = {}
    local defaults = {}

    for i, offset in ipairs(entry.Offset) do
        table.insert(prompts, string.format("Offset 0x%X ONHex", offset))
        table.insert(defaults, entry.ONHex[i] or entry.ONHex[1])
        table.insert(prompts, string.format("Offset 0x%X OFFHex", offset))
        table.insert(defaults, entry.OFFHex[i] or entry.OFFHex[1])
    end

    local result = gg.prompt(prompts, defaults)
    if result then
        for i, offset in ipairs(entry.Offset) do
            entry.ONHex[i] = result[2 * i - 1]
            entry.OFFHex[i] = result[2 * i]
        end
        gg.toast("Hexå€¤ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼")
    else
        gg.alert("Hexå€¤ã®å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚")
    end
end

-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚ã®è‡ªå‹•å®Ÿè¡Œ
function executeOnStart()
    local subMenus = getDynamicSubConfigs() -- ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‹•çš„ã«å–å¾—
    for _, subMenu in ipairs(subMenus) do
        initializeConfig(subMenu)
        for _, key in ipairs(configKeys) do
            local entry = config[key]
            -- ToggleStatus ãŒ false ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if entry.ToggleStatus == false then
            else
                if entry.Type == "Toggle" then
                    autoToggle(entry)
                elseif entry.Func then
                    entry.Func(entry.value)
                end
            end
        end
    end
end

-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®çµæœã‚’å‡¦ç†
function handleMenuResult(result)
    if not result then return false end
    local index = 1
    for _, key in ipairs(configKeys) do
        local entry = config[key]
        if entry.State then -- ToggleStatusã®ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
            if entry.Type == "Toggle" then
                if result[index] ~= entry.value then
                    if entry.Func then
                        entry.Func()
                    else
                        autoToggle(entry)
                    end
                end
            elseif entry.Type == "InputValue" then
                local numValue = tonumber(result[index])
                if numValue and numValue ~= entry.value then
                    entry.value = numValue
                    if entry.Func then
                        entry.Func(numValue)
                    end
                elseif not numValue then
                    gg.alert(entry.Name .. " ã®å€¤ãŒç„¡åŠ¹ã§ã™")
                    return false
                end
            end
        end
        index = index + 1
    end
    return true
end

-- è¨­å®šã®åˆæœŸåŒ–
function initializeConfig(subMenu)
    if not savedConfigs[subMenu] then
        savedConfigs[subMenu] = {configKeys = {}, config = {}}
        local selectedConfig = subConfigs[subMenu]
        if not selectedConfig then
            gg.alert("Error: Undefined subMenu '" .. subMenu .. "'")
            return
        end
        for _, item in ipairs(selectedConfig) do
            -- ToggleStatusãŒæœªè¨­å®šã®å ´åˆã€åˆæœŸå€¤ã‚’falseã«è¨­å®š
            if item.ToggleStatus == nil then
                item.ToggleStatus = false
            end
            savedConfigs[subMenu].config[item.Name] = item
            table.insert(savedConfigs[subMenu].configKeys, item.Name)
        end
    end

    config = savedConfigs[subMenu].config
    configKeys = savedConfigs[subMenu].configKeys
end

-- ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è‡ªå‹•å–å¾—ã™ã‚‹é–¢æ•°
function getDynamicSubConfigs()
    local subMenuKeys = {}
    for subMenuName, _ in pairs(subConfigs) do
        table.insert(subMenuKeys, subMenuName)
    end
    return subMenuKeys
end


-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç”Ÿæˆ
function generateMenu()
    local prompts, defaults, types = {}, {}, {}
    for _, key in ipairs(configKeys) do
        local entry = config[key]
        table.insert(prompts, entry.Name)
        table.insert(defaults, entry.value)
        table.insert(types, entry.Type == "Toggle" and "checkbox" or "number")
    end
    return prompts, defaults, types
end

-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
function MainMenu()
    local menu = gg.choice({
    "ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼", 
    "ãƒ‘ã‚ºãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼", 
    "ç„¡åŠ¹åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼", 
    "ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼",
    "ãƒ‰ãƒ­ãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼", 
    "çµ‚äº†"}, nil, "ğŸ˜TAPIScriptğŸ˜œ\nğŸ“±AppName:ã·ã«ã·ã«\n2æ¬¡é…å¸ƒãŒç™ºè¦šã—ãŸå ´åˆScliptã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™")
    if menu == 1 then
        SubMenu("Main")
    elseif menu == 2 then
        SubMenu("Puzzle")
    elseif menu == 3 then
        SubMenu("Disable")
    elseif menu == 4 then
        SubMenu("Other")
    elseif menu == 5 then
        SubMenu("Drop")
    elseif menu == 6 then
        os.exit()
    end
end

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ–‡å­—åˆ—åŒ–ã™ã‚‹é–¢æ•°
function serializeTable(tbl, indent)
    indent = indent or ""
    local result = "{\n"
    local nextIndent = indent .. "  "
    for key, value in pairs(tbl) do
        local formattedKey = type(key) == "string" and string.format("[%q]", key) or string.format("[%s]", key)
        if type(value) == "table" then
            result = result .. string.format("%s%s = %s,\n", nextIndent, formattedKey, serializeTable(value, nextIndent))
        else
            local formattedValue = type(value) == "string" and string.format("%q", value) or tostring(value)
            result = result .. string.format("%s%s = %s,\n", nextIndent, formattedKey, formattedValue)
        end
    end
    result = result .. indent .. "}"
    return result
end

-- è¨­å®šã‚’ä¿å­˜ã™ã‚‹
function SaveMenus()
    local saveFilePath = "/storage/emulated/0/ã·ã«ã·ã«Savedmenu.lua"
    local savedData = {}

    -- ç¾åœ¨ã®ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’ä¿å­˜
    for subMenuName, subMenuItems in pairs(subConfigs) do
        savedData[subMenuName] = {}
        for _, item in ipairs(subMenuItems) do
            table.insert(savedData[subMenuName], {
                Name = item.Name,
                Type = item.Type,
                Value = item.value -- ç¾åœ¨ã®å€¤ã‚’ä¿å­˜
            })
        end
    end

    -- ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€
    local file = io.open(saveFilePath, "w")
    if not file then
        gg.alert("ã‚¨ãƒ©ãƒ¼: è¨­å®šã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã€‚\nãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚")
        return
    end

    file:write("return " .. serializeTable(savedData))
    file:close()

    gg.toast("æ©Ÿèƒ½ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚")
end

-- è¨­å®šã‚’å¾©å…ƒã—ã¦çŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹
function PopMenus()
    local saveFilePath = "/storage/emulated/0/ã·ã«ã·ã«Savedmenu.lua"

    -- ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦å†…å®¹ã‚’èª­ã¿è¾¼ã‚€
    local file = io.open(saveFilePath, "r")
    if not file then
        gg.alert("ã‚¨ãƒ©ãƒ¼: ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚")
        return
    end

    local fileContent = file:read("*all")
    file:close()

    -- ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’ Lua ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã‚€
    local success, savedData = pcall(load(fileContent))
    if not success or type(savedData) ~= "table" then
        gg.alert("ã‚¨ãƒ©ãƒ¼: ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒç„¡åŠ¹ã§ã™ã€‚\nãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚")
        return
    end

    -- ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’åæ˜ ã—ã¦çŠ¶æ…‹ã‚’å¤‰æ›´
    for subMenuName, savedSubMenu in pairs(savedData) do
        local currentSubMenu = subConfigs[subMenuName]
        if currentSubMenu then
            for _, savedItem in ipairs(savedSubMenu) do
                for _, currentItem in ipairs(currentSubMenu) do
                    if currentItem.Name == savedItem.Name then
                        -- å€¤ãŒç•°ãªã‚‹å ´åˆã®ã¿å¤‰æ›´ã‚’é©ç”¨
                        if currentItem.value ~= savedItem.Value then
                            currentItem.value = savedItem.Value

                            -- çŠ¶æ…‹å¤‰æ›´ã‚’åæ˜ 
                            if currentItem.Type == "Toggle" then
                                if currentItem.Func then
                                    currentItem.Func() -- ãƒˆã‚°ãƒ«ã®çŠ¶æ…‹ã‚’å¤‰æ›´
                                else
                                    -- ãƒˆã‚°ãƒ«ã®ãƒ¡ãƒ¢ãƒªå¤‰æ›´
                                    local hex = savedItem.Value and currentItem.ONHex or currentItem.OFFHex
                                    local success = setHexMemory(currentItem.lib, currentItem.Offset, hex)
                                    if not success then
                                        gg.alert("ã‚¨ãƒ©ãƒ¼: " .. currentItem.Name .. " ã®çŠ¶æ…‹ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
                                    end
                                end
                            elseif currentItem.Type == "InputValue" then
                                if currentItem.Func then
                                    currentItem.Func(currentItem.value) -- å…¥åŠ›å€¤ã‚’é©ç”¨ã—ã¦å®Ÿè¡Œ
                                end
                            end
                        end
                        break
                    end
                end
            end
        else
            gg.alert("è­¦å‘Š: ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ '" .. subMenuName .. "' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
        end
    end

    gg.toast("ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒå¾©å…ƒã•ã‚Œã¾ã—ãŸã€‚")
end

-- ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é †ç•ªé€šã‚Šå–å¾—
function getDynamicSubConfigs()
    local subMenuKeys = {}
    for subMenuName, _ in pairs(subConfigs) do
        table.insert(subMenuKeys, subMenuName)
    end
    table.sort(subMenuKeys) -- å¿…è¦ã«å¿œã˜ã¦ã‚½ãƒ¼ãƒˆï¼ˆä»»æ„ï¼‰
    return subMenuKeys
end

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ Lua ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§æ–‡å­—åˆ—åŒ–ã™ã‚‹é–¢æ•°
function serializeTable(tbl, depth)
    depth = depth or 0
    local indent = string.rep("    ", depth)
    local lines = {"{"}

    for k, v in pairs(tbl) do
        local key = type(k) == "string" and string.format("%q", k) or k
        local value
        if type(v) == "table" then
            value = serializeTable(v, depth + 1)
        elseif type(v) == "string" then
            value = string.format("%q", v)
        else
            value = tostring(v)
        end
        table.insert(lines, indent .. "    [" .. key .. "] = " .. value .. ",")
    end

    table.insert(lines, indent .. "}")
    return table.concat(lines, "\n")
end

-- ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‡¦ç†
function SubMenu(subMenu)
    initializeConfig(subMenu)
    local prompts, defaults, types = generateMenu()
    local result = gg.prompt(prompts, defaults, types)
    if not handleMenuResult(result) then return end
end

-- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
executeOnStart() -- ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚ã«ä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹
loadSavedLibrary()

while true do
    if gg.isVisible(true) then
        gg.setVisible(false)
        MainMenu()
    end
    gg.sleep(100)
end
